<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="roomDAO">
	<!-- 방찾기용 home&LookOver 공용 -->
	<!-- 시/도 가져오기 -->
	<select id="getSido" resultType="String">
		select DISTINCT	SUBSTR(branchaddr1,0,2) from member where position='지점장' and brstatus=0
	</select>
	<!-- 선택된 시/도에 따른 구군 가져오기 -->
	<select id="getGugun" resultType="String">
		<![CDATA[select DISTINCT SUBSTR(branchaddr1,INSTR(branchaddr1, ' ', 1,1)+1,INSTR(branchaddr1, ' ',1,1)+1)  
		from member where branchaddr1 like #{sido}|| '%']]>
	</select>
	
	<!-- for LookOver -->
	<!-- 선택 안돼있을시 방정보 가져오기 -->
	<select id="getRoomInfo" resultType="roomInfo">
		<![CDATA[select rom.branchName,roomName,roomEx1,roomEx2,roomEx3,romf.Fname from room rom 
				 join roomfile romf on rom.roomNum=romf.roomNum join member mem on rom.branchName=mem.branchName 
				 where romf.filenum=1 ]]>
		<if test="sidogugun!='시/도 선택 '">
		<![CDATA[ and mem.branchAddr1 like #{sidogugun}||'%']]>
		</if>
	</select>
	
	<!-- 스케줄 가져오기 -->
	<select id="getRoomInfoAndSchedule" resultType="roomInfo">
		<![CDATA[
		WITH CTE AS 
		(
		select rom.branchName,roomName,rom.roomNum,roomEx1,roomEx2,roomEx3,romf.Fname,reservstate from room rom 
		join roomfile romf on rom.roomNum=romf.roomNum join member mem on rom.branchName=mem.branchName join roomreserv romrs on rom.roomNum=romrs.roomNum
		where romf.filenum=1 and mem.branchAddr1 like #{sidogugun}||'%' and to_char(startdate,'yyyy-mm-dd') like #{startdate}
		)
     	SELECT roomNum, count(regexp_substr (reservstate, '[^,]+', 1, rn)) as reservstate, branchName,roomName,roomEx1,roomEx2,roomEx3,fname,reservstate
     	FROM   cte
     	CROSS JOIN 
     	(
          SELECT ROWNUM rn
          FROM  (SELECT MAX (LENGTH (regexp_replace (reservstate, '[^,]+'))) + 1 max_l from cte)
          connect by level <= max_l
         )
     	WHERE regexp_substr (reservstate, '[^,]+', 1, rn) IS NOT NULL
    	 group by roomNum, branchName, roomName, roomEx1, roomEx2, roomEx3, fname, reservstate having count(regexp_substr (reservstate, '[^,]+', 1, rn))<=44
   		 order by roomNum;
		]]>
	</select>
	
	<!--  for roomDetail  -->
	<!-- 방상세 정보 가져오기-->
	<select id="getDetailRoomInfo" resultType="roomInfo">
		select * from room
	</select>
	
	<!-- 예약 집어넣기 -->
	<insert id="inReserveRoom">
		<![CDATA[insert into roomReserv values(select nvl(max(reservNumber)+1,1),#{roomNum},#{reservstate},sysdate)]]>
	</insert>
	<!-- startDate로 오늘 날짜가 있는 방은 update로 뒤에 어펜드 처리 -->
	<update id="upReserveRoom">
		<![CDATA[
		update roomReserv set reservstate=concat(reservstate,','||#{reservstate}) 
		where roomNum=(select nvl(max(reservNumber),1) from roomreserv where roomNum=#{roomNum})
		]]>
	</update>
	
</mapper>