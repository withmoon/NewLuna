<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="payAndReservDAO">
	
	<!-- 예약 테이블에 현재날짜을 가지고 있는 room이 있는지 -->
	<select id="checkReservStartdate" resultType="Integer">
		<![CDATA[select roomnum,reservNumber from roomreserv where roomnum=#{roomNum} and to_char(startdate,'yyyy-mm-dd') like #{startdate}]]>
	</select>
	
	<!-- 예약 집어넣기 -->
	<insert id="inReserveRoom">
		<![CDATA[insert into roomReserv values((select nvl(max(reservNumber)+1,1) from roomreserv),#{startdate},#{roomNum},#{reservstate})]]>
	</insert>
	<!-- startDate로 오늘 날짜가 있는 방은 update로 뒤에 어펜드 처리 -->
	<update id="upReserveRoom">
		<![CDATA[
		update roomReserv set reservstate=concat(reservstate,#{reservstate}) 
		where reservNumber=#{reservNumber}
		]]>
	</update>
	
	<!-- 결제 집어넣기 -->
	<insert id="inRoomPayment">
		<![CDATA[insert into roompayment values
		(#{imp_uid},#{merchant_uid},#{branchName},#{roomNum},#{id},#{reserveTime},#{payAmount},#{status},#{paid_at},#{receipt_url},#{pg_provider},#{pg_tid}
		,(select nvl(max(seq)+1,1) from roompayment),#{reservdate})]]>
	</insert>
	
	<!-- for MyPage -->
	<!-- lastely list -->
	<select id="getUserPayInfo" resultType="myPageInfo">
	<![CDATA[
		select mem.branchAddr1,rom.roomName,rom.roomNum,romp.branchName,romp.status,romp.imp_uid,
		to_char(reservdate,'yyyy-mm-dd') as reservdate,SUBSTR(reserveTime,0,2)||':'||SUBSTR(reserveTime,3,2) as starttime,
		SUBSTR(reserveTime,LENGTH(reserveTime)-4,2)||':'||SUBSTR(reserveTime,LENGTH(reserveTime)-2,2) as endtime,status,receipt_url 
		from roomPayment romp join room rom on rom.roomNum=romp.roomNum join member mem on romp.branchName=mem.branchName 
		where romp.id=#{id} and to_char(reservdate,'yyyymmdd')||(SUBSTR(reserveTime,0,4))>=to_char(sysdate,'yyyymmddHHMi')  order by reservdate asc
		]]>
	</select>
	<!-- 6개월 단위로 자름 last list -->
	<select id="getUserReservedInfo" resultType="myPageInfo">
	<![CDATA[
		select mem.branchAddr1,rom.roomName,rom.roomNum,romp.branchName,romp.status,romp.imp_uid,
		to_char(reservdate,'yyyy-mm-dd') as reservdate,SUBSTR(reserveTime,0,2)||':'||SUBSTR(reserveTime,3,2) as starttime,
		SUBSTR(reserveTime,LENGTH(reserveTime)-4,2)||':'||SUBSTR(reserveTime,LENGTH(reserveTime)-2,2) as endtime,status,receipt_url 
		from roomPayment romp join room rom on rom.roomNum=romp.roomNum join member mem on romp.branchName=mem.branchName 
		where romp.id=#{id} and to_char(sysdate-30*6,'yyyymmddHHMi')<to_char(reservdate,'yyyymmdd')||(SUBSTR(reserveTime,0,4)) 
		and to_char(reservdate,'yyyymmdd')||(SUBSTR(reserveTime,0,4))<=to_char(sysdate,'yyyymmddHHMi')  order by reservdate desc
		]]>
	</select>
	
	<update id="cancleReserve">
		<![CDATA[update roompayment set status=-2 where id=#{id} and imp_uid=#{imp_uid}]]>
	</update>
	
</mapper>